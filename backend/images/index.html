<!-- <!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vite App</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html> -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubsy - Partial Vue App</title>
    <!-- 1. Load Vue.js from CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* GLOBAL STYLES */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #fefefe; color: #333; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background-color: #fff; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 24px; font-weight: 800; color: #0e0a07; text-decoration: none; }
        .nav-btn { padding: 10px 20px; background: none; border: none; font-size: 16px; cursor: pointer; color: #555; }
        .nav-btn.active { font-weight: bold; color: #0e0a07; }
        .cart-btn { position: relative; background-color: #f0c419; color: #0e0a07; font-weight: bold; border-radius: 8px; }
        .cart-count { background: #c0392b; color: white; padding: 2px 6px; border-radius: 50%; font-size: 12px; margin-left: 5px; }

        /* CONTAINERS */
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        
        /* LESSONS VIEW */
        .search-bar { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .search-input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
        .sort-select { padding: 12px; border: 1px solid #ccc; border-radius: 8px; }

        .lessons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .lesson-card { border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; background: white; }
        .lesson-image { width: 100%; height: 200px; object-fit: cover; background: #eee; }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .lesson-title { font-size: 18px; font-weight: 700; }
        .lesson-info { font-size: 14px; color: #666; display: flex; justify-content: space-between; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: auto; transition: 0.2s; }
        .btn-add { background-color: #0e0a07; color: white; }
        .btn-add:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* CART VIEW */
        .cart-item { display: flex; gap: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; align-items: center; }
        .cart-img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
        .cart-details { flex: 1; }
        .btn-remove { background: #c0392b; color: white; width: auto; padding: 8px 16px; }

        .checkout-box { background: #f9f9f9; padding: 30px; border-radius: 12px; margin-top: 40px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .error { color: #c0392b; font-size: 12px; margin-top: 5px; }
        .btn-checkout { background-color: #2ecc71; color: white; font-size: 18px; }

        /* LOADING/EMPTY STATES */
        .state-msg { text-align: center; font-size: 18px; color: #777; margin-top: 50px; }
    </style>
</head>
<body>

<div id="app">
    <!-- HEADER -->
    <header class="header">
        <a href="#" class="logo" @click.prevent="currentView = 'lessons'">Hubsy</a>
        <nav>
            <button class="nav-btn" :class="{active: currentView === 'lessons'}" @click="currentView = 'lessons'">
                Lessons
            </button>
            <button class="nav-btn cart-btn" :class="{active: currentView === 'cart'}" @click="currentView = 'cart'">
                Cart <span class="cart-count">{{ cart.length }}</span>
            </button>
        </nav>
    </header>

    <!-- LESSONS VIEW -->
    <div v-if="currentView === 'lessons'" class="container">
        <!-- Search & Sort -->
        <div class="search-bar">
            <input v-model="searchQuery" class="search-input" placeholder="Search lessons...">
            <select v-model="sortAttribute" class="sort-select">
                <option value="title">Sort by Subject</option>
                <option value="location">Sort by Location</option>
                <option value="price">Sort by Price</option>
                <option value="spaces">Sort by Availability</option>
            </select>
            <button class="sort-select" @click="toggleSortOrder">
                {{ sortOrder === 'asc' ? 'Ascending' : 'Descending' }}
            </button>
        </div>

        <!-- List -->
        <div v-if="loading" class="state-msg">Loading lessons...</div>
        <div v-else class="lessons-grid">
            <div v-for="lesson in filteredLessons" :key="lesson._id" class="lesson-card">
                <img :src="getImageUrl(lesson.image)" class="lesson-image" alt="Lesson Image">
                <div class="card-body">
                    <h3 class="lesson-title">{{ lesson.title }}</h3>
                    <p>üìç {{ lesson.location }}</p>
                    <div class="lesson-info">
                        <span>üí∞ ${{ lesson.price }}</span>
                        <span>üéü {{ lesson.spaces }} spaces left</span>
                    </div>
                    <!-- Add to Cart Button -->
                    <button 
                        class="btn btn-add" 
                        @click="addToCart(lesson)"
                        :disabled="lesson.spaces <= 0 || isInCart(lesson)"
                    >
                        {{ getButtonText(lesson) }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CART VIEW -->
    <div v-if="currentView === 'cart'" class="container">
        <h2>Shopping Cart</h2>
        
        <div v-if="cart.length === 0" class="state-msg">
            Your cart is empty. <br>
            <button class="nav-btn" @click="currentView = 'lessons'">Back to Lessons</button>
        </div>

        <div v-else>
            <!-- Cart Items -->
            <div v-for="item in cart" :key="item._id" class="cart-item">
                <img :src="getImageUrl(item.image)" class="cart-img">
                <div class="cart-details">
                    <h3>{{ item.title }}</h3>
                    <p>${{ item.price }}</p>
                </div>
                <button class="btn btn-remove" @click="removeFromCart(item)">Remove</button>
            </div>

            <!-- Checkout Form -->
            <div class="checkout-box">
                <h3>Checkout</h3>
                <div class="form-group">
                    <label>Name</label>
                    <input v-model="checkout.name" class="form-input" type="text" placeholder="Enter your name">
                    <p v-if="!isNameValid && checkout.name" class="error">Name must be letters only</p>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input v-model="checkout.phone" class="form-input" type="tel" placeholder="Enter phone number">
                    <p v-if="!isPhoneValid && checkout.phone" class="error">Phone must be numbers only</p>
                </div>
                <button 
                    class="btn btn-checkout" 
                    :disabled="!isFormValid"
                    @click="submitOrder"
                >
                    {{ orderStatus || 'Checkout' }}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // --- STATE ---
            const lessons = ref([]);
            const cart = ref([]);
            const currentView = ref('lessons'); // 'lessons' or 'cart'
            
            // Search & Sort
            const searchQuery = ref('');
            const sortAttribute = ref('title');
            const sortOrder = ref('asc');
            
            // Loading
            const loading = ref(true);
            
            // Checkout
            const checkout = ref({ name: '', phone: '' });
            const orderStatus = ref('');

            // --- API URL (RENDER) ---
            const API_URL = "https://hubsy-2-0.onrender.com";

            // --- METHODS ---
            
            // 1. Fetch Lessons
            const fetchLessons = async () => {
                try {
                    const res = await fetch(`${API_URL}/api/lessons`);
                    lessons.value = await res.json();
                } catch (err) {
                    console.error("Fetch error:", err);
                } finally {
                    loading.value = false;
                }
            };

            // 2. Image Helper
            const getImageUrl = (img) => {
                if (!img) return 'https://placehold.co/600x400';
                return `${API_URL}/images/${img}`;
            };

            // 3. Cart Logic
            const addToCart = (lesson) => {
                if (lesson.spaces > 0) {
                    cart.value.push(lesson);
                    // Optimistic UI update: subtract space locally
                    // lesson.spaces--; 
                }
            };

            const removeFromCart = (itemToRemove) => {
                cart.value = cart.value.filter(item => item._id !== itemToRemove._id);
                // Return space locally if you want
                // const lesson = lessons.value.find(l => l._id === itemToRemove._id);
                // if (lesson) lesson.spaces++;
            };

            const isInCart = (lesson) => {
                return cart.value.some(item => item._id === lesson._id);
            };

            const getButtonText = (lesson) => {
                if (lesson.spaces <= 0) return 'Sold Out';
                if (isInCart(lesson)) return 'In Cart';
                return 'Add to Cart';
            };

            // 4. Computed Filter/Sort
            const filteredLessons = computed(() => {
                let temp = lessons.value;

                // Search
                if (searchQuery.value) {
                    const q = searchQuery.value.toLowerCase();
                    temp = temp.filter(l => 
                        l.title.toLowerCase().includes(q) || 
                        l.location.toLowerCase().includes(q)
                    );
                }

                // Sort
                temp = temp.sort((a, b) => {
                    let valA = a[sortAttribute.value];
                    let valB = b[sortAttribute.value];
                    
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    if (valA < valB) return sortOrder.value === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder.value === 'asc' ? 1 : -1;
                    return 0;
                });

                return temp;
            });

            const toggleSortOrder = () => {
                sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
            };

            // 5. Checkout Validation
            const isNameValid = computed(() => /^[a-zA-Z\s]+$/.test(checkout.value.name));
            const isPhoneValid = computed(() => /^[0-9]+$/.test(checkout.value.phone));
            const isFormValid = computed(() => isNameValid.value && isPhoneValid.value);

            // 6. Submit Order
            const submitOrder = async () => {
                orderStatus.value = "Processing...";
                
                const orderData = {
                    name: checkout.value.name,
                    phone: checkout.value.phone,
                    lessonIds: cart.value.map(i => i._id),
                    spacesBooked: cart.value.length,
                    total: cart.value.reduce((sum, i) => sum + i.price, 0)
                };

                try {
                    // POST Order
                    const res = await fetch(`${API_URL}/api/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });

                    if (res.ok) {
                        // PUT Update Spaces for each item
                        for (const item of cart.value) {
                             const newSpaces = item.spaces - 1;
                             await fetch(`${API_URL}/api/lessons/${item._id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ spaces: newSpaces })
                             });
                        }

                        alert("Order Submitted Successfully!");
                        cart.value = [];
                        checkout.value = { name: '', phone: '' };
                        orderStatus.value = '';
                        currentView.value = 'lessons';
                        fetchLessons(); // Refresh data to see new spaces
                    } else {
                        orderStatus.value = "Failed. Try again.";
                    }
                } catch (e) {
                    console.error(e);
                    orderStatus.value = "Error.";
                }
            };

            // Lifecycle
            onMounted(() => {
                fetchLessons();
            });

            return {
                currentView, lessons, cart, loading,
                searchQuery, sortAttribute, sortOrder,
                filteredLessons, toggleSortOrder,
                getImageUrl, addToCart, removeFromCart, isInCart, getButtonText,
                checkout, isNameValid, isPhoneValid, isFormValid, submitOrder, orderStatus
            };
        }
    }).mount('#app');
</script>

</body>
</html>